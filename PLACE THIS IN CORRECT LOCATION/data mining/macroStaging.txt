Sub Button1_Click()
    Dim sDictValue As String
    Dim sNewDictValue As String
    Dim sDictKey As String
    Dim iMaxStage As Integer
    Dim iStage As Integer
    Dim sTemp As String
    Dim iTime As Integer
    
    iRowCount = Sheets("Sheet1").Range("A100000").End(xlUp).Row
    Set objDict = CreateObject("Scripting.Dictionary")
    For i = 2 To iRowCount
        sDictKey = Range("A" & i)
        iStage = 1
        iMaxStage = 0
        iTime = 0
        sTemp = ""
        
        Do While Range("A" & i) = sDictKey
            If InStr(1, Range("E" & i), "StageAll") = 0 Then
                If InStr(1, Range("D" & i), "Pass") Then
                    If InStr(1, Range("E" & i), "Stage1") And iStage = 1 Then
                        Exit Do
                    ElseIf InStr(1, Range("E" & i), "Stage") Then
                        iStage = Mid(Range("E" & i), InStr(1, Range("E" & i), "Stage") + Len("Stage"), 1)
                        If iMaxStage = 0 Then
                            iMaxStage = iStage
                        End If
                        If iTime = 0 Or InStr(1, Range("E" & i), Range("E" & i - 1)) Then
                            iTime = Range("C" & i)
                        Else
                            iTime = iTime + Range("C" & i)
                        End If
                        
                        If iStage = 1 Then
                            If objDict.exists(sDictKey) Then
                                sTemp = objDict.Item(sDictKey)
                                arrTemp = Split(sTemp, ":")
                                If arrTemp(3) = iMaxStage Then
                                    arrTemp(0) = arrTemp(0) + 1
                                    arrTemp(1) = arrTemp(1) + 1
                                    arrTemp(4) = arrTemp(4) + iTime
                                    objDict.Item(sDictKey) = arrTemp(0) & ":" & arrTemp(1) & ":" & arrTemp(2) & ":" & iMaxStage & ":" & arrTemp(4)
                                End If
                            Else
                                sDictValue = "1:1:0:" & iMaxStage & ":" & iTime
                                objDict.Add sDictKey, sDictValue
                            End If
                            Exit Do
                        Else
                            i = i + 1
                            If Range("A" & i) <> sDictKey Then
                                i = i - 1
                                Exit Do
                            End If
                        End If
                    End If
                ElseIf InStr(1, Range("D" & i), "Fail") Then
                    iStage = Mid(Range("E" & i), InStr(1, Range("E" & i), "Stage") + Len("Stage"), 1)
                    If objDict.exists(sDictKey) Then
                        sTemp = objDict.Item(sDictKey)
                        arrTemp = Split(sTemp, ":")
                        If arrTemp(3) < iStage Then
                            arrTemp(3) = iStage
                        End If
                        arrTemp(0) = arrTemp(0) + 1
                        arrTemp(2) = arrTemp(2) + 1
                        objDict.Item(sDictKey) = arrTemp(0) & ":" & arrTemp(1) & ":" & arrTemp(2) & ":" & arrTemp(3) & ":" & arrTemp(4)
                    Else
                        sDictValue = "1:0:1:" & iStage & ":0"
                        objDict.Add sDictKey, sDictValue
                    End If
                    Exit Do
                Else
                    Exit Do
                End If
            Else
                i = i + 1
                If Range("A" & i) <> sDictKey Then
                    i = i - 1
                    Exit Do
                End If
            End If
        Loop

    Next
   
    Call writeInExcel(objDict, "C:\Demo_DB_Graphs\demoGraphDataBreakdownRelease16_3.xlsx")
        
End Sub

Function writeInExcel(objKeyValue, sFilePath)
    
    Set objExcel = CreateObject("Excel.Application")
    MsgBox "Writing in Excel.... Please wait."
    objExcel.Workbooks.Open (sFilePath)
    objExcel.Visible = False
    With objExcel.Worksheets("StagingTCAvgTimeTakenToPass")
        .Range("A2:F" & .Range("A2").End(xlDown).Row).ClearContents
        .Range("B2:F" & .Range("B2").End(xlDown).Row).ClearContents
        .Range("C2:F" & .Range("C2").End(xlDown).Row).ClearContents
        .Range("D2:F" & .Range("D2").End(xlDown).Row).ClearContents
        .Range("E2:F" & .Range("E2").End(xlDown).Row).ClearContents
        .Range("F2:F" & .Range("F2").End(xlDown).Row).ClearContents
        .Range("G2:F" & .Range("G2").End(xlDown).Row).ClearContents
    End With
    iRow = 2
    For Each objKey In objKeyValue.keys()
        objExcel.Workbooks(1).Worksheets("StagingTCAvgTimeTakenToPass").Cells(iRow, 1).Value = objKey
        arrValues = Split(objKeyValue.Item(objKey), ":")
        objExcel.Workbooks(1).Worksheets("StagingTCAvgTimeTakenToPass").Cells(iRow, 2).Value = arrValues(0)
        objExcel.Workbooks(1).Worksheets("StagingTCAvgTimeTakenToPass").Cells(iRow, 3).Value = arrValues(1)
        objExcel.Workbooks(1).Worksheets("StagingTCAvgTimeTakenToPass").Cells(iRow, 4).Value = arrValues(2)
        objExcel.Workbooks(1).Worksheets("StagingTCAvgTimeTakenToPass").Cells(iRow, 5).Value = arrValues(3)
        objExcel.Workbooks(1).Worksheets("StagingTCAvgTimeTakenToPass").Cells(iRow, 6).Value = arrValues(4)
        If arrValues(1) <> 0 Then
            fAvgTime = arrValues(4) / arrValues(1)
        Else
            fAvgTime = 0
        End If
        objExcel.Workbooks(1).Worksheets("StagingTCAvgTimeTakenToPass").Cells(iRow, 7).Value = fAvgTime
        iRow = iRow + 1
    Next
    
    objExcel.ActiveWorkbook.Save
    objExcel.ActiveWorkbook.Close
    objExcel.Application.Quit
    'Cleanup
    Set objExcel = Nothing
    MsgBox "Staging data pasted in demo graphs sheet"
End Function

